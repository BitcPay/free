name: Windows 11 Pro RDP with Tailscale
on:
  workflow_dispatch:
    inputs:
      edition:
        description: 'Windows Edition'
        required: true
        default: 'Pro'
        type: choice
        options:
        - 'Pro'
        - 'Enterprise'
      optimization:
        description: 'Performance Profile'
        required: true
        default: 'Development'
        type: choice
        options:
        - 'Development'
        - 'Gaming'
        - 'Server'

env:
  WINDOWS_EDITION: ${{ github.event.inputs.edition }}
  OPTIMIZATION_PROFILE: ${{ github.event.inputs.optimization }}
  RDP_PORT: 3389
  SESSION_TIMEOUT: 180

jobs:
  windows11-pro-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ env.SESSION_TIMEOUT }}
    
    steps:
    # ============== WINDOWS 11 PRO INITIALIZATION ==============
    - name: ü™ü Configure Windows 11 Pro Settings
      run: |
        Write-Host "ü™ü Configuring Windows 11 Professional..."
        
        # Enable Windows 11 Pro features
        if ($env:WINDOWS_EDITION -eq "Pro" -or $env:WINDOWS_EDITION -eq "Enterprise") {
            # Enable Hyper-V for Pro/Enterprise
            Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All -NoRestart
            Enable-WindowsOptionalFeature -Online -FeatureName Containers -All -NoRestart
            
            # Enable Windows Sandbox (Pro/Enterprise only)
            Enable-WindowsOptionalFeature -Online -FeatureName "Containers-DisposableClientVM" -All -NoRestart
        }
        
        # Disable Windows 11 "consumer" features
        $consumerFeatures = @(
            "Clipboard",
            "WindowsMediaPlayer",
            "XboxGipSvc",
            "XblAuthManager",
            "XblGameSave",
            "XboxNetApiSvc"
        )
        
        foreach ($feature in $consumerFeatures) {
            Get-WindowsCapability -Online -Name "*$feature*" | Remove-WindowsCapability -Online -ErrorAction SilentlyContinue
        }

    # ============== SECURITY & CREDENTIALS ==============
    - name: üîê Generate Professional Credentials
      id: credentials
      run: |
        # Windows 11 compatible secure password generation
        function Generate-Windows11Password {
            param([int]$Length = 20)
            $charSets = @{
                Lower = 'abcdefghijklmnopqrstuvwxyz'
                Upper = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
                Numbers = '0123456789'
                Special = '!@#$%^&*()-_=+[]{}|;:,.<>?'
            }
            
            # Ensure password meets Windows complexity requirements
            $password = @(
                $charSets.Lower[(Get-Random -Minimum 0 -Maximum $charSets.Lower.Length)]
                $charSets.Upper[(Get-Random -Minimum 0 -Maximum $charSets.Upper.Length)]
                $charSets.Numbers[(Get-Random -Minimum 0 -Maximum $charSets.Numbers.Length)]
                $charSets.Special[(Get-Random -Minimum 0 -Maximum $charSets.Special.Length)]
            )
            
            # Fill remaining characters
            $allChars = $charSets.Lower + $charSets.Upper + $charSets.Numbers + $charSets.Special
            for ($i = $password.Length; $i -lt $Length; $i++) {
                $password += $allChars[(Get-Random -Minimum 0 -Maximum $allChars.Length)]
            }
            
            # Shuffle the password
            $password = -join ($password | Get-Random -Count $password.Length)
            return $password
        }
        
        $username = "Win11-$(Get-Random -Minimum 10000 -Maximum 99999)"
        $password = Generate-Windows11Password -Length 18
        $computerName = "GH-WIN11-$((Get-Date).ToString('yyMMddHHmm'))"
        
        echo "::add-mask::$password"
        echo "::add-mask::$username"
        
        echo "WIN11_USER=$username" >> $env:GITHUB_ENV
        echo "WIN11_PASS=$password" >> $env:GITHUB_ENV
        echo "WIN11_HOSTNAME=$computerName" >> $env:GITHUB_ENV
        
        # Rename computer (requires admin)
        Rename-Computer -NewName $computerName -Force -ErrorAction SilentlyContinue

    # ============== TAILSCALE SETUP ==============
    - name: üõ°Ô∏è Install Tailscale VPN
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "üîí Installing Tailscale for Windows 11..."
        
        # Download latest Tailscale
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale-win11.msi"
        
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UserAgent "Windows11-RDP-Setup"
        
        # Install with Windows 11 optimizations
        $installArgs = @(
            "/i", "`"$installerPath`"",
            "/qn",
            "/norestart",
            "ALLUSERS=1",
            "SERVICESTARTTYPE=auto"
        )
        
        Start-Process "msiexec.exe" -ArgumentList $installArgs -Wait -NoNewWindow
        Start-Sleep -Seconds 10
        
        # Connect to Tailscale
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=$env:TAILSCALE_AUTH_KEY `
            --hostname=$env:WIN11_HOSTNAME `
            --accept-dns=true `
            --accept-routes=true `
            --shields-up=false `
            --exit-node=${{ github.event.inputs.edition == 'Enterprise' && 'true' || 'false' }}
        
        # Get connection info
        $retries = 0
        while ($retries -lt 15) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
            if ($tsIP) {
                echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                Write-Host "‚úÖ Tailscale IP: $tsIP"
                break
            }
            Start-Sleep -Seconds 2
            $retries++
        }
        
        if (-not $tsIP) {
            Write-Host "‚ö†Ô∏è Using fallback IP detection"
            $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
            $tsIP = $tsStatus.Self.TailscaleIPs[0]
            echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
        }

    # ============== WINDOWS 11 RDP CONFIGURATION ==============
    - name: üñ•Ô∏è Enable Windows 11 RDP with Security
      run: |
        Write-Host "üéØ Configuring Windows 11 Remote Desktop..."
        
        # 1. Enable RDP with modern security
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" `
            -Name "fDenyTSConnections" -Value 0 -Type DWord -Force
        
        # 2. Configure for Windows 11 (keep NLA enabled for security)
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
            -Name "UserAuthentication" -Value 1 -Type DWord -Force
        
        # 3. Windows 11 specific RDP enhancements
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
            -Name "MaxMonitors" -Value 4 -Type DWord
        
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
            -Name "MaxXResolution" -Value 7680 -Type DWord
        
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
            -Name "MaxYResolution" -Value 4320 -Type DWord
        
        # 4. Enable modern RDP features
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
            -Name "AVC444ModePreferred" -Value 1 -Type DWord  # H.264/AVC 444 mode
        
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
            -Name "DWMFRAMEINTERVAL" -Value 15 -Type DWord  # Smooth animation
        
        # 5. Configure Windows 11 firewall
        netsh advfirewall firewall delete rule name="RDP-Windows11" 2>$null
        netsh advfirewall firewall add rule name="RDP-Windows11" dir=in action=allow protocol=TCP localport=3389 description="Windows 11 RDP via Tailscale"
        
        # 6. Start services
        Set-Service -Name TermService -StartupType Automatic
        Start-Service -Name TermService -ErrorAction SilentlyContinue
        
        # 7. Additional Windows 11 service
        Set-Service -Name "SessionEnv" -StartupType Automatic
        Start-Service -Name "SessionEnv" -ErrorAction SilentlyContinue

    # ============== WINDOWS 11 USER CREATION ==============
    - name: üë§ Create Windows 11 Professional User
      run: |
        Write-Host "üë§ Creating Windows 11 Professional User Account..."
        
        # Convert password to secure string
        $securePassword = ConvertTo-SecureString $env:WIN11_PASS -AsPlainText -Force
        
        # Check if user exists
        $existingUser = Get-LocalUser -Name $env:WIN11_USER -ErrorAction SilentlyContinue
        if ($existingUser) {
            Write-Host "üîÑ Updating existing user..."
            Set-LocalUser -Name $env:WIN11_USER -Password $securePassword
        } else {
            Write-Host "üÜï Creating new user..."
            $userParams = @{
                Name = $env:WIN11_USER
                Password = $securePassword
                FullName = "Windows 11 RDP User"
                Description = "Temporary RDP user for GitHub Actions Windows 11 session"
                PasswordNeverExpires = $true
                UserMayNotChangePassword = $true
                AccountNeverExpires = $true
            }
            New-LocalUser @userParams
        }
        
        # Add to required groups
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:WIN11_USER -ErrorAction SilentlyContinue
        
        # Optional: Add to Administrators (comment out for security)
        # Add-LocalGroupMember -Group "Administrators" -Member $env:WIN11_USER -ErrorAction SilentlyContinue
        
        # Enable the account
        Enable-LocalUser -Name $env:WIN11_USER
        
        Write-Host "‚úÖ User '$env:WIN11_USER' created/updated successfully"

    # ============== WINDOWS 11 PERFORMANCE OPTIMIZATION ==============
    - name: ‚ö° Optimize Windows 11 Performance
      run: |
        Write-Host "‚ö° Applying $env:OPTIMIZATION_PROFILE optimizations..."
        
        if ($env:OPTIMIZATION_PROFILE -eq "Development") {
            # Development optimizations
            Write-Host "üõ†Ô∏è Applying Development optimizations..."
            
            # Disable visual effects for better RDP performance
            Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" `
                -Name "VisualFXSetting" -Value 2 -Type DWord
            
            # Optimize for background services
            powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c  # High performance
            
            # Disable animations
            Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" `
                -Name "UserPreferencesMask" -Value ([byte[]](0x90,0x12,0x03,0x80,0x10,0x00,0x00,0x00)) -Type Binary
            
        } elseif ($env:OPTIMIZATION_PROFILE -eq "Gaming") {
            # Gaming optimizations
            Write-Host "üéÆ Applying Gaming optimizations..."
            
            # Game Mode
            Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\PolicyManager\current\device\GameDVR" `
                -Name "AllowGameDVR" -Value 1 -Type DWord
            
            # Performance power plan
            powercfg /setactive e9a42b02-d5df-448d-aa00-03f14749eb61  # Ultimate performance
            
        } elseif ($env:OPTIMIZATION_PROFILE -eq "Server") {
            # Server-like optimizations
            Write-Host "üñ•Ô∏è Applying Server optimizations..."
            
            # Disable visual effects completely
            Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" `
                -Name "UserPreferencesMask" -Value ([byte[]](0x90,0x12,0x01,0x80,0x10,0x00,0x00,0x00)) -Type Binary
            
            # Disable Windows animations
            Disable-Animations
        }
        
        # Common optimizations for all profiles
        Write-Host "üîß Applying common optimizations..."
        
        # Disable Cortana
        Get-AppxPackage -Name *Microsoft.549981C3F5F10* | Remove-AppxPackage -ErrorAction SilentlyContinue
        
        # Disable telemetry
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" `
            -Name "AllowTelemetry" -Value 0 -Type DWord
        
        # Disable Windows Spotlight
        Set-ItemProperty -Path "HKCU:\Software\Policies\Microsoft\Windows\CloudContent" `
            -Name "DisableWindowsSpotlightFeatures" -Value 1 -Type DWord

    # ============== WINDOWS 11 TOOLS INSTALLATION ==============
    - name: üõ†Ô∏è Install Windows 11 Development Tools
      run: |
        Write-Host "üõ†Ô∏è Installing Windows 11 Professional Tools..."
        
        # 1. Install Chocolatey if not present
        if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        }
        
        # 2. Base development tools
        $baseTools = @(
            "git",
            "vscode",
            "python",
            "nodejs",
            "docker-desktop",
            "postman",
            "sysinternals",
            "7zip",
            "googlechrome",
            "firefox"
        )
        
        foreach ($tool in $baseTools) {
            choco install $tool -y --no-progress --limit-output --ignore-checksums
        }
        
        # 3. Windows 11 specific tools
        $win11Tools = @(
            "powertoys",
            "windows-terminal",
            "microsoft-windows-terminal",
            "wsl2",
            "ubuntu",
            "dotnet-sdk"
        )
        
        foreach ($tool in $win11Tools) {
            choco install $tool -y --no-progress --limit-output
        }
        
        # 4. PowerShell modules
        Install-Module -Name PowerShellGet -Force -AllowClobber -Scope AllUsers
        Install-Module -Name PSWindowsUpdate -Force -AllowClobber -Scope AllUsers
        Install-Module -Name Terminal-Icons -Force -AllowClobber -Scope CurrentUser
        
        # 5. VS Code extensions for Windows 11
        code --install-extension ms-vscode.powershell
        code --install-extension ms-python.python
        code --install-extension ms-vscode-remote.remote-wsl
        code --install-extension ms-azuretools.vscode-docker
        code --install-extension GitHub.copilot

    # ============== VERIFICATION & TESTING ==============
    - name: ‚úÖ Verify Windows 11 RDP Setup
      run: |
        Write-Host "üîç Verifying Windows 11 RDP Configuration..."
        
        # 1. Check RDP service status
        $rdpService = Get-Service -Name TermService
        Write-Host "RDP Service Status: $($rdpService.Status)"
        
        # 2. Check firewall rule
        $firewallRule = Get-NetFirewallRule -Name "RDP-Windows11" -ErrorAction SilentlyContinue
        if ($firewallRule) {
            Write-Host "‚úÖ Firewall rule configured"
        } else {
            Write-Host "‚ö†Ô∏è Firewall rule missing"
        }
        
        # 3. Test RDP port locally
        $listener = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Where-Object {$_.State -eq "Listen"}
        if ($listener) {
            Write-Host "‚úÖ RDP listening on port 3389"
        } else {
            Write-Host "‚ùå RDP not listening"
        }
        
        # 4. Test Tailscale connectivity
        if (Test-Path "C:\Program Files\Tailscale\tailscale.exe") {
            $tsStatus = & "C:\Program Files\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
            Write-Host "Tailscale Status: $($tsStatus.BackendState)"
            Write-Host "Tailscale IP: $env:TAILSCALE_IP"
        }
        
        # 5. Check user exists
        $userExists = Get-LocalUser -Name $env:WIN11_USER -ErrorAction SilentlyContinue
        if ($userExists) {
            Write-Host "‚úÖ User account exists"
        }

    # ============== DISPLAY CONNECTION INFORMATION ==============
    - name: üìã Windows 11 Connection Dashboard
      run: |
        Write-Host ""
        Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        Write-Host "                    ü™ü WINDOWS 11 PROFESSIONAL RDP SESSION                              "
        Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        Write-Host ""
        Write-Host "üìä SYSTEM INFORMATION"
        Write-Host "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        Write-Host "   Edition       : Windows 11 $env:WINDOWS_EDITION"
        Write-Host "   Hostname      : $env:WIN11_HOSTNAME"
        Write-Host "   Optimized for : $env:OPTIMIZATION_PROFILE"
        Write-Host "   Session ID    : $env:GITHUB_RUN_ID"
        Write-Host "   Timeout       : $env:SESSION_TIMEOUT minutes"
        Write-Host ""
        Write-Host "üîó CONNECTION DETAILS"
        Write-Host "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        Write-Host "   Tailscale IP  : $env:TAILSCALE_IP"
        Write-Host "   RDP Port      : $env:RDP_PORT"
        Write-Host "   Security      : NLA Enabled + Tailscale Encryption"
        Write-Host "   Resolution    : Up to 8K (7680x4320)"
        Write-Host ""
        Write-Host "üë§ CREDENTIALS"
        Write-Host "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        Write-Host "   Username      : $env:WIN11_USER"
        Write-Host "   Password      : ******** (securely generated)"
        Write-Host ""
        Write-Host "   üí° Actual password in workflow environment variables"
        Write-Host ""
        Write-Host "üõ†Ô∏è  INSTALLED TOOLS"
        Write-Host "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        Write-Host "   ‚Ä¢ Windows Terminal + PowerShell 7"
        Write-Host "   ‚Ä¢ VS Code with WSL & Docker extensions"
        Write-Host "   ‚Ä¢ Git, Python, Node.js"
        Write-Host "   ‚Ä¢ Docker Desktop"
        Write-Host "   ‚Ä¢ WSL 2 with Ubuntu"
        Write-Host "   ‚Ä¢ Windows PowerToys"
        Write-Host "   ‚Ä¢ Chrome, Firefox, Postman"
        Write-Host ""
        Write-Host "üöÄ QUICK CONNECT"
        Write-Host "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        Write-Host "   Windows RDP  : mstsc /v:$env:TAILSCALE_IP"
        Write-Host "   Command      : xfreerdp /v:$env:TAILSCALE_IP /u:$env:WIN11_USER +glyph-cache"
        Write-Host ""
        Write-Host "‚ö° PERFORMANCE TIPS"
        Write-Host "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        Write-Host "   ‚Ä¢ Use Windows Terminal for better performance"
        Write-Host "   ‚Ä¢ Enable H.264 in RDP client settings"
        Write-Host "   ‚Ä¢ Adjust color depth to 16-bit for slower connections"
        Write-Host ""
        Write-Host "‚ö†Ô∏è  SECURITY NOTES"
        Write-Host "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        Write-Host "   ‚Ä¢ Session auto-terminates after timeout"
        Write-Host "   ‚Ä¢ All connections encrypted via Tailscale"
        Write-Host "   ‚Ä¢ Credentials are temporary and unique"
        Write-Host "   ‚Ä¢ User has limited privileges (security best practice)"
        Write-Host ""
        Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        Write-Host ""
        
        # Add to GitHub summary
        echo "## ü™ü Windows 11 $env:WINDOWS_EDITION RDP Session" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Hostname:** $env:WIN11_HOSTNAME" >> $GITHUB_STEP_SUMMARY
        echo "**Tailscale IP:** \`$env:TAILSCALE_IP\`" >> $GITHUB_STEP_SUMMARY
        echo "**Username:** \`$env:WIN11_USER\`" >> $GITHUB_STEP_SUMMARY
        echo "**Session Timeout:** $env:SESSION_TIMEOUT minutes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Connect:** \`mstsc /v:$env:TAILSCALE_IP\`" >> $GITHUB_STEP_SUMMARY

    # ============== SESSION MAINTENANCE ==============
    - name: ‚è≥ Maintain Windows 11 Session
      timeout-minutes: ${{ env.SESSION_TIMEOUT }}
      run: |
        Write-Host ""
        Write-Host "‚è∞ Windows 11 Session Active - Monitoring..."
        Write-Host "   Press 'Cancel workflow' in GitHub to terminate early"
        Write-Host ""
        
        $startTime = Get-Date
        $timeout = [int]$env:SESSION_TIMEOUT
        
        function Show-SessionStatus {
            $elapsed = (Get-Date) - $startTime
            $remaining = $timeout - [math]::Round($elapsed.TotalMinutes, 0)
            
            # Get system info
            $cpu = Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average | Select-Object -ExpandProperty Average
            $ram = Get-CimInstance Win32_OperatingSystem | ForEach-Object { "{0:N1}" -f (($_.TotalVisibleMemorySize - $_.FreePhysicalMemory) / 1MB) }
            $connections = (quser 2>$null | Measure-Object).Count
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Status: "
            Write-Host "   Time remaining: $remaining minutes"
            Write-Host "   CPU Usage: $cpu%"
            Write-Host "   RAM Used: $ram GB"
            Write-Host "   RDP Connections: $connections"
            Write-Host ""
        }
        
        while ($true) {
            Show-SessionStatus
            
            # Check timeout
            $elapsed = (Get-Date) - $startTime
            if ($elapsed.TotalMinutes -ge $timeout) {
                Write-Host "‚è∞ Session timeout reached - Shutting down..."
                break
            }
            
            Start-Sleep -Seconds 60
        }

    # ============== CLEANUP ==============
    - name: üßπ Windows 11 Cleanup
      if: always()
      run: |
        Write-Host ""
        Write-Host "üßπ Cleaning up Windows 11 session..."
        
        # 1. Disconnect all RDP sessions
        Write-Host "   Disconnecting RDP sessions..."
        logoff /server:localhost 2>$null
        
        # 2. Remove user account
        Write-Host "   Removing temporary user..."
        Remove-LocalUser -Name $env:WIN11_USER -ErrorAction SilentlyContinue
        
        # 3. Disable RDP
        Write-Host "   Securing RDP..."
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" `
            -Name "fDenyTSConnections" -Value 1 -Type DWord -Force
        
        # 4. Clean firewall
        Write-Host "   Removing firewall rules..."
        Remove-NetFirewallRule -Name "RDP-Windows11" -ErrorAction SilentlyContinue
        
        # 5. Disconnect Tailscale
        Write-Host "   Disconnecting Tailscale..."
        if (Test-Path "C:\Program Files\Tailscale\tailscale.exe") {
            & "C:\Program Files\Tailscale\tailscale.exe" down 2>$null
        }
        
        Write-Host "‚úÖ Windows 11 cleanup complete"
        Write-Host ""
