name: 30-Day RDP Marathon

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # Every 5 hours

jobs:
  rdp-session:
    runs-on: windows-latest
    timeout-minutes: 350  # 5 hours 50 minutes (leaves buffer)
    
    steps:
    - name: Check if we should continue the chain
      id: check_days
      run: |
        # Create/read a counter file
        $counterFile = "rdp_counter.txt"
        if (Test-Path $counterFile) {
            $days = [int](Get-Content $counterFile)
        } else {
            $days = 0
        }
        
        if ($days -ge 30) {
            echo "::warning::30-day marathon complete!"
            echo "STOP=true" >> $env:GITHUB_ENV
        } else {
            $days++
            $days | Out-File $counterFile
            echo "DAY=$days" >> $env:GITHUB_ENV
            echo "STOP=false" >> $env:GITHUB_ENV
        }
    
    - name: Setup RDP (Day ${{ env.DAY }}/30)
      if: env.STOP == 'false'
      run: |
        # Your RDP setup code
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        netsh advfirewall firewall add rule name="30DayRDP" dir=in action=allow protocol=TCP localport=3389
        
        # Create temp user
        $pass = ConvertTo-SecureString "TempPass${{ github.run_id }}" -AsPlainText -Force
        New-LocalUser -Name "Day${{ env.DAY }}" -Password $pass -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "Day${{ env.DAY }}"
        
        echo "RDP_USER=Day${{ env.DAY }}" >> $env:GITHUB_ENV
        echo "RDP_PASS=TempPass${{ github.run_id }}" >> $env:GITHUB_ENV
    
    - name: Keep Alive for 5.8 Hours
      if: env.STOP == 'false'
      run: |
        $endTime = (Get-Date).AddMinutes(348)  # 5.8 hours
        while ((Get-Date) -lt $endTime) {
            $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
            Write-Host "â³ Day ${{ env.DAY }}/30 - Session time left: ${remaining} minutes"
            Write-Host "ğŸ‘¤ User: ${{ env.RDP_USER }}"
            Write-Host "ğŸ”‘ Pass: ${{ env.RDP_PASS }}"
            Write-Host "ğŸ”„ Next session starts in 10 minutes..."
            Start-Sleep -Seconds 300  # Check every 5 minutes
        }
    
    - name: Trigger Next Session
      if: env.STOP == 'false'
      run: |
        Write-Host "ğŸ“¤ This session ending. Next one will auto-start in 10 minutes..."
        # The schedule will trigger the next run automatically
