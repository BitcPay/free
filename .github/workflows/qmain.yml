name: Enable RDP with Tailscale
on: [workflow_dispatch]

jobs:
  rdp-access:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸš€ Install Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "ðŸ“¥ Installing Tailscale..."
        $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath
        msiexec.exe /i $installerPath /qn /norestart
        Start-Sleep -Seconds 10
        
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $env:TAILSCALE_AUTH_KEY --hostname "github-rdp-${{ github.run_id }}" --accept-dns=false
        $tailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV

    - name: ðŸ”§ Enable and Configure RDP
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ”§ CONFIGURING RDP ACCESS"
        Write-Host "======================================================"
        
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        
        # Start RDP services
        Set-Service -Name TermService -StartupType Automatic
        Start-Service TermService
        
        # Configure firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        netsh advfirewall firewall add rule name="GitHub Runner RDP" dir=in action=allow protocol=TCP localport=3389
        
        Write-Host "âœ… RDP configured"

    - name: ðŸ‘¤ Create RDP User with Simple Password
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ‘¤ CREATING RDP USER"
        Write-Host "======================================================"
        
        $username = "githubuser"
        
        # SIMPLE password generation without System.Web
        # Create a predictable but unique password based on run ID
        $runId = "${{ github.run_id }}"
        $basePassword = "GitHubRDP" + $runId.Substring($runId.Length - 6) + "!"
        
        # Make it 12 characters exactly
        if ($basePassword.Length -lt 12) {
            $basePassword = $basePassword.PadRight(12, '0')
        } elseif ($basePassword.Length -gt 12) {
            $basePassword = $basePassword.Substring(0, 12)
        }
        
        $password = $basePassword
        
        # Store credentials
        echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        
        Write-Host "Generated password: $password"
        
        # Create user using NET command (most reliable)
        Write-Host "Creating user with NET command..."
        net user $username $password /add /fullname:"GitHub RDP User" /y
        net user $username /active:yes
        
        # Add to groups
        net localgroup "Remote Desktop Users" $username /add
        net localgroup "Administrators" $username /add
        
        Write-Host "âœ… User created"

    - name: ðŸ“‹ Show RDP Connection Info
      run: |
        Write-Host ""
        Write-Host "======================================================"
        Write-Host "ðŸ”— RDP CONNECTION INFORMATION"
        Write-Host "======================================================"
        Write-Host ""
        Write-Host "ðŸŒ TAILSCALE ACCESS:"
        Write-Host "   IP Address: $env:TAILSCALE_IP"
        Write-Host "   MagicDNS: github-rdp-${{ github.run_id }}.your-tailnet.ts.net"
        Write-Host ""
        Write-Host "ðŸ”‘ RDP CREDENTIALS:"
        Write-Host "   ðŸ‘¤ USERNAME: $env:RDP_USERNAME"
        Write-Host "   ðŸ” PASSWORD: $env:RDP_PASSWORD"
        Write-Host ""
        Write-Host "ðŸš€ CONNECT NOW:"
        Write-Host "   mstsc /v:$env:TAILSCALE_IP"
        Write-Host ""
        Write-Host "â° TIME LIMIT: ~25 minutes"
        Write-Host ""
        Write-Host "ðŸ”§ RDP STATUS:"
        Get-Service TermService | Format-Table Status, Name
        Write-Host ""
        Write-Host "ðŸ“¡ PORT CHECK:"
        netstat -an | findstr ":3389" || echo "Port 3389 not listening"
        Write-Host "======================================================"

    - name: â³ Keep Runner Alive
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ”„ KEEPING RUNNER ACTIVE"
        Write-Host "======================================================"
        
        $timeout = 1500  # 25 minutes
        $startTime = Get-Date
        
        while (((Get-Date) - $startTime).TotalSeconds -lt $timeout) {
            $elapsed = [math]::Round(((Get-Date) - $startTime).TotalSeconds)
            $remaining = $timeout - $elapsed
            $minutes = [math]::Floor($remaining / 60)
            $seconds = $remaining % 60
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] â° Time left: ${minutes}m ${seconds}s"
            
            # Keep RDP service running
            $rdpService = Get-Service TermService -ErrorAction SilentlyContinue
            if ($rdpService.Status -ne "Running") {
                Write-Host "âš ï¸  RDP service stopped. Restarting..."
                Start-Service TermService
            }
            
            # Show active sessions
            try {
                $sessions = (qwinsta 2>$null | findstr "rdp" | Measure-Object).Count
                Write-Host "   Active RDP sessions: $sessions"
            } catch { }
            
            Start-Sleep -Seconds 30
        }
        
        Write-Host "â° Time's up! Cleaning up..."

    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ§¹ CLEANUP"
        Write-Host "======================================================"
        
        # Remove user
        net user $env:RDP_USERNAME /delete /y 2>$null
        
        # Disable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1
        Stop-Service TermService -Force -ErrorAction SilentlyContinue
        
        # Remove firewall rule
        netsh advfirewall firewall delete rule name="GitHub Runner RDP" 2>$null
        
        # Disconnect Tailscale
        & "C:\Program Files\Tailscale\tailscale.exe" down 2>$null
        
        Write-Host "âœ… Cleanup complete!"
