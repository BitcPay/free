name: Enable RDP with Tailscale
on: [workflow_dispatch]

jobs:
  rdp-access:
    runs-on: windows-latest
    timeout-minutes: 30  # Extended timeout for RDP session
    
    steps:
    - name: ğŸš€ Install Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        # Download and install Tailscale
        Write-Host "ğŸ“¥ Installing Tailscale..."
        $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath
        msiexec.exe /i $installerPath /qn /norestart
        Start-Sleep -Seconds 10
        
        # Connect to Tailscale
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $env:TAILSCALE_AUTH_KEY --hostname "github-rdp-${{ github.run_id }}" --accept-dns=false
        
        # Get Tailscale IP
        $tailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV

    - name: ğŸ”§ Enable and Configure RDP
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ”§ CONFIGURING RDP ACCESS"
        Write-Host "======================================================"
        
        # 1. Enable RDP service
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        
        # 2. Configure Network Level Authentication (disabled for easier access)
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1
        
        # 3. Set RDP to start automatically
        Set-Service -Name TermService -StartupType Automatic
        Start-Service TermService
        
        # 4. Allow RDP through firewall (for Tailscale IP only)
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        New-NetFirewallRule -DisplayName "Tailscale RDP Access" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow -ErrorAction SilentlyContinue
        
        # 5. Disable sleep/power saving
        powercfg -change -standby-timeout-ac 0
        powercfg -change -monitor-timeout-ac 0
        
        Write-Host "âœ… RDP Service enabled and configured"

    - name: ğŸ‘¤ Create or Reset RDP User
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ‘¤ SETTING UP RDP USER ACCOUNT"
        Write-Host "======================================================"
        
        $username = "github-rdp-user"
        $password = [System.Web.Security.Membership]::GeneratePassword(12, 3)
        
        # Store credentials in environment variables
        echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        
        # Check if user exists
        $userExists = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
        
        if ($userExists) {
            # Reset existing user
            Write-Host "ğŸ”„ Resetting existing user: $username"
            Set-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force)
        } else {
            # Create new user
            Write-Host "ğŸ†• Creating new user: $username"
            $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
            New-LocalUser -Name $username -Password $securePassword -FullName "GitHub RDP User" -Description "Temporary RDP access"
        }
        
        # Add to Remote Desktop Users group
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
        
        # Add to Administrators group (if you need admin access)
        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
        
        # Enable the account
        Enable-LocalUser -Name $username
        
        Write-Host "âœ… User account configured"

    - name: ğŸ“‹ Show RDP Connection Info
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ”— RDP CONNECTION INFORMATION"
        Write-Host "======================================================"
        Write-Host ""
        Write-Host "ğŸ–¥ï¸  TAILSCALE CONNECTION DETAILS:"
        Write-Host "   Tailscale IPv4: $env:TAILSCALE_IP"
        Write-Host "   MagicDNS: github-rdp-${{ github.run_id }}.your-tailnet.ts.net"
        Write-Host "   Port: 3389"
        Write-Host ""
        Write-Host "ğŸ‘¤ RDP CREDENTIALS:"
        Write-Host "   ğŸ‘‰ USERNAME: $env:RDP_USERNAME"
        Write-Host "   ğŸ‘‰ PASSWORD: $env:RDP_PASSWORD"
        Write-Host ""
        Write-Host "ğŸš€ QUICK CONNECT COMMAND (from another Tailscale device):"
        Write-Host "   mstsc /v:$env:TAILSCALE_IP"
        Write-Host ""
        Write-Host "â° REMAINING TIME:"
        Write-Host "   This runner will be available for ~$((30 - 5)) more minutes"
        Write-Host "   (GitHub timeout: 30 minutes)"
        Write-Host ""
        Write-Host "ğŸ”§ TROUBLESHOOTING:"
        Write-Host "   1. Ensure Tailscale is running on your local machine"
        Write-Host "   2. Verify you're in the same Tailnet"
        Write-Host "   3. Try connecting with IP if DNS doesn't work"
        Write-Host "   4. Use 'tailscale status' to verify connectivity"
        Write-Host ""
        Write-Host "âš ï¸  SECURITY NOTES:"
        Write-Host "   - These credentials are temporary"
        Write-Host "   - Access is private via Tailscale"
        Write-Host "   - Runner auto-destroys after timeout"
        Write-Host "   - Change password if reusing runner"
        Write-Host "======================================================"
        
        # Keep runner alive by showing countdown
        Write-Host ""
        Write-Host "â³ Runner will stay active for RDP access..."
        Write-Host "Press Ctrl+C in workflow logs to stop early"

    - name: â³ Keep Runner Alive (RDP Session)
      run: |
        # This step keeps the runner alive for RDP access
        Write-Host "======================================================"
        Write-Host "ğŸ”„ KEEPING RUNNER ACTIVE FOR RDP"
        Write-Host "======================================================"
        Write-Host ""
        Write-Host "ğŸ“¡ RDP Service Status:"
        Get-Service TermService | Format-Table Status, Name, DisplayName
        
        Write-Host ""
        Write-Host "ğŸ”— Active Connections Check:"
        netstat -an | findstr :3389 || echo "No active connections yet"
        
        Write-Host ""
        Write-Host "â° Countdown until runner termination:"
        
        # Run for ~25 minutes (leaving 5 minutes for cleanup)
        $timeout = 1500  # 25 minutes in seconds
        $startTime = Get-Date
        
        while (((Get-Date) - $startTime).TotalSeconds -lt $timeout) {
            $elapsed = [math]::Round(((Get-Date) - $startTime).TotalSeconds)
            $remaining = $timeout - $elapsed
            $minutes = [math]::Floor($remaining / 60)
            $seconds = $remaining % 60
            
            Write-Host "Time remaining: ${minutes}m ${seconds}s - Connected users: $(qwinsta 2>$null | findstr 'Active Disc' | Measure-Object | Select-Object -ExpandProperty Count)"
            
            # Check if RDP port is listening
            $rdpListening = netstat -an | findstr ":3389" | findstr "LISTENING"
            if (-not $rdpListening) {
                Write-Host "âš ï¸  RDP service stopped! Restarting..."
                Start-Service TermService
            }
            
            Start-Sleep -Seconds 30
        }
        
        Write-Host "â° Time limit reached, preparing to exit..."

    - name: ğŸ§¹ Cleanup Before Exit
      if: always()
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ§¹ CLEANUP & SECURITY"
        Write-Host "======================================================"
        
        # 1. Disconnect Tailscale
        Write-Host "ğŸ”Œ Disconnecting Tailscale..."
        & "C:\Program Files\Tailscale\tailscale.exe" down
        
        # 2. Disable RDP
        Write-Host "ğŸ”’ Disabling RDP..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1
        Stop-Service TermService
        
        # 3. Remove temporary user
        Write-Host "ğŸ—‘ï¸  Removing temporary user..."
        $username = "github-rdp-user"
        Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
        
        # 4. Remove firewall rule
        Write-Host "ğŸ›¡ï¸  Removing firewall rule..."
        Remove-NetFirewallRule -DisplayName "Tailscale RDP Access" -ErrorAction SilentlyContinue
        
        # 5. Show final message
        Write-Host "âœ… Cleanup complete. Runner shutting down..."
        Write-Host ""
        Write-Host "ğŸ” All temporary access has been revoked"
        Write-Host "ğŸ“ Credentials are no longer valid"
        Write-Host "ğŸš« RDP service is now disabled"
