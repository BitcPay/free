name: Enable RDP with Tailscale
on: [workflow_dispatch]

jobs:
  rdp-access:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸš€ Install Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "ðŸ“¥ Installing Tailscale..."
        $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath
        msiexec.exe /i $installerPath /qn /norestart
        Start-Sleep -Seconds 10
        
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $env:TAILSCALE_AUTH_KEY --hostname "github-rdp-${{ github.run_id }}" --accept-dns=false
        $tailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV

    - name: ðŸ”§ Enable and Configure RDP
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ”§ CONFIGURING RDP ACCESS"
        Write-Host "======================================================"
        
        # 1. Check current RDP status
        Write-Host "ðŸ“Š Current RDP Status:"
        Get-Service TermService, UmRdpService, SessionEnv | Format-Table Name, Status, StartType
        
        # 2. Enable RDP in registry
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        
        # 3. Disable NLA for easier connection
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1
        
        # 4. Start RDP services in correct order
        Write-Host "ðŸ”„ Starting RDP services..."
        
        # Set services to auto-start
        Set-Service -Name SessionEnv -StartupType Automatic -ErrorAction SilentlyContinue
        Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
        Set-Service -Name TermService -StartupType Automatic
        
        # Start services in order
        Start-Service SessionEnv -ErrorAction SilentlyContinue
        Start-Service UmRdpService -ErrorAction SilentlyContinue
        Start-Service TermService
        
        Write-Host "âœ… RDP services started"
        
        # 5. Configure firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        netsh advfirewall firewall add rule name="GitHub Runner RDP" dir=in action=allow protocol=TCP localport=3389
        
        Write-Host "âœ… Firewall configured"

    - name: ðŸ‘¤ Create RDP User Account
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ‘¤ SETTING UP RDP USER ACCOUNT"
        Write-Host "======================================================"
        
        $username = "github-rdp-user"
        
        # Generate random password using built-in PowerShell methods
        # Method 1: Using .NET Cryptography
        Add-Type -AssemblyName System.Web
        $password = [System.Web.Security.Membership]::GeneratePassword(12, 3)
        
        # Method 2: Alternative if Method 1 fails
        if (-not $password -or $password.Length -lt 8) {
            Write-Host "âš ï¸  Using alternative password generation..."
            $chars = @('abcdefghijkmnpqrstuvwxyz', 'ABCDEFGHJKLMNPQRSTUVWXYZ', '23456789', '!@#$%^&*')
            $password = -join ((1..12) | ForEach-Object {
                $charSet = $chars[(Get-Random -Minimum 0 -Maximum $chars.Count)]
                $charSet[(Get-Random -Minimum 0 -Maximum $charSet.Length)]
            })
        }
        
        echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        
        Write-Host "Generated password length: $($password.Length)"
        
        # Check and create/update user
        $user = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
        
        if ($user) {
            Write-Host "ðŸ”„ Updating existing user..."
            try {
                $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
                Set-LocalUser -Name $username -Password $securePassword
                Enable-LocalUser -Name $username
                Write-Host "âœ… User updated"
            } catch {
                Write-Host "âŒ Error updating user: $_"
                # Try alternative method
                net user $username $password 2>$null
            }
        } else {
            Write-Host "ðŸ†• Creating new user..."
            try {
                $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
                New-LocalUser -Name $username -Password $securePassword -FullName "GitHub RDP User"
                Enable-LocalUser -Name $username
                Write-Host "âœ… User created"
            } catch {
                Write-Host "âŒ Error creating user: $_"
                # Try using net command as fallback
                net user $username $password /add /fullname:"GitHub RDP User" /y 2>$null
                net user $username /active:yes 2>$null
            }
        }
        
        # Add to required groups using multiple methods
        Write-Host "ðŸ‘¥ Adding user to groups..."
        
        # Method 1: PowerShell
        try {
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
        } catch {
            # Method 2: net command
            net localgroup "Remote Desktop Users" $username /add 2>$null
            net localgroup "Administrators" $username /add 2>$null
        }
        
        # Verify user setup
        Write-Host ""
        Write-Host "âœ… User verification:"
        Get-LocalUser -Name $username -ErrorAction SilentlyContinue | Format-Table Name, Enabled -AutoSize

    - name: ðŸ“‹ Show RDP Connection Info
      run: |
        Write-Host ""
        Write-Host "======================================================"
        Write-Host "ðŸ”— RDP CONNECTION INFORMATION"
        Write-Host "======================================================"
        Write-Host ""
        Write-Host "ðŸŒ TAILSCALE ACCESS:"
        Write-Host "   IP Address: $env:TAILSCALE_IP"
        Write-Host "   DNS: github-rdp-${{ github.run_id }}.your-tailnet.ts.net"
        Write-Host ""
        Write-Host "ðŸ”‘ RDP CREDENTIALS:"
        Write-Host "   ðŸ‘¤ USERNAME: $env:RDP_USERNAME"
        Write-Host "   ðŸ” PASSWORD: $env:RDP_PASSWORD"
        Write-Host ""
        Write-Host "ðŸš€ CONNECT COMMANDS:"
        Write-Host "   Windows: mstsc /v:$env:TAILSCALE_IP"
        Write-Host "   macOS: Use Microsoft Remote Desktop"
        Write-Host "   Linux: xfreerdp /v:$env:TAILSCALE_IP /u:$env:RDP_USERNAME /p:$env:RDP_PASSWORD"
        Write-Host ""
        Write-Host "â° TIME LIMIT: ~25 minutes remaining"
        Write-Host ""
        Write-Host "ðŸ”§ SERVICES STATUS:"
        Get-Service TermService, UmRdpService, SessionEnv | Format-Table Name, Status -AutoSize
        Write-Host ""
        Write-Host "ðŸ“¡ PORT CHECK:"
        $listening = netstat -an | findstr ":3389" | findstr "LISTENING"
        if ($listening) {
            Write-Host "   âœ… Port 3389 is listening"
        } else {
            Write-Host "   âŒ Port 3389 is NOT listening"
            Write-Host "   Trying to restart RDP services..."
            Start-Service TermService -ErrorAction SilentlyContinue
        }
        Write-Host "======================================================"
        Write-Host ""
        Write-Host "ðŸ’¡ TIPS:"
        Write-Host "   1. Make sure Tailscale is running on your local machine"
        Write-Host "   2. Use the IP if DNS doesn't work"
        Write-Host "   3. Disable NLA in RDP client if connection fails"
        Write-Host "   4. Check 'tailscale status' to verify connectivity"
        Write-Host ""

    - name: â³ Keep Alive with Service Monitoring
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ”„ KEEPING RUNNER ACTIVE FOR RDP"
        Write-Host "======================================================"
        
        $timeout = 1500  # 25 minutes
        $startTime = Get-Date
        
        while (((Get-Date) - $startTime).TotalSeconds -lt $timeout) {
            $elapsed = [math]::Round(((Get-Date) - $startTime).TotalSeconds)
            $remaining = $timeout - $elapsed
            $minutes = [math]::Floor($remaining / 60)
            $seconds = $remaining % 60
            
            Write-Host ""
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] â° Time left: ${minutes}m ${seconds}s"
            Write-Host "----------------------------------------"
            
            # Check RDP services
            Write-Host "ðŸ”§ SERVICE STATUS:"
            $services = @{
                "TermService" = "Remote Desktop Services"
                "UmRdpService" = "RDP Redirector"
                "SessionEnv" = "Remote Desktop Configuration"
            }
            
            foreach ($service in $services.Keys) {
                $status = Get-Service -Name $service -ErrorAction SilentlyContinue
                if ($status) {
                    Write-Host "   $($services[$service]): $($status.Status)"
                    if ($status.Status -ne "Running" -and $service -eq "TermService") {
                        Write-Host "   âš ï¸  Starting $service..."
                        Start-Service -Name $service -ErrorAction SilentlyContinue
                    }
                } else {
                    Write-Host "   $($services[$service]): âŒ Not found"
                }
            }
            
            # Check active connections
            Write-Host ""
            Write-Host "ðŸ“¡ CONNECTIONS:"
            try {
                $sessionCount = (qwinsta 2>$null | Select-String "rdp-tcp" | Measure-Object).Count
                Write-Host "   Active RDP sessions: $sessionCount"
            } catch {
                Write-Host "   Active RDP sessions: 0"
            }
            
            $listening = (netstat -an 2>$null | Select-String ":3389" | Select-String "LISTENING" | Measure-Object).Count
            Write-Host "   Port 3389 listening: $(if ($listening -gt 0) {'âœ…'} else {'âŒ'})"
            
            Write-Host "----------------------------------------"
            Start-Sleep -Seconds 30
        }
        
        Write-Host ""
        Write-Host "â° Time limit reached, starting cleanup..."

    - name: ðŸ§¹ Cleanup Before Exit
      if: always()
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ§¹ CLEANING UP"
        Write-Host "======================================================"
        
        Write-Host "ðŸ›‘ Stopping RDP services..."
        
        # Stop services in reverse order
        $services = @("TermService", "UmRdpService", "SessionEnv")
        
        foreach ($service in $services) {
            try {
                $svc = Get-Service -Name $service -ErrorAction SilentlyContinue
                if ($svc -and $svc.Status -eq "Running") {
                    Write-Host "   Stopping $service..."
                    Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
                    Write-Host "   âœ… Stopped"
                }
            } catch {
                Write-Host "   âš ï¸  Could not stop $service"
            }
            Start-Sleep -Seconds 1
        }
        
        Write-Host ""
        Write-Host "ðŸ”’ Disabling RDP..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -ErrorAction SilentlyContinue
        
        Write-Host ""
        Write-Host "ðŸ‘¤ Removing user..."
        $username = "github-rdp-user"
        try {
            Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
            Write-Host "   âœ… User removed"
        } catch {
            Write-Host "   âš ï¸  Could not remove user (may not exist)"
        }
        
        Write-Host ""
        Write-Host "ðŸ›¡ï¸  Removing firewall rule..."
        netsh advfirewall firewall delete rule name="GitHub Runner RDP" 2>$null
        
        Write-Host ""
        Write-Host "ðŸ”Œ Disconnecting Tailscale..."
        & "C:\Program Files\Tailscale\tailscale.exe" down 2>$null
        
        Write-Host ""
        Write-Host "âœ… Cleanup completed!"
