name: Enable RDP with Tailscale
on: [workflow_dispatch]

jobs:
  rdp-access:
    runs-on: windows-latest
    timeout-minutes: 99000000
    
    steps:
    - name: ðŸš€ Install Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "ðŸ“¥ Installing Tailscale..."
        try {
            $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
            $installerPath = "$env:TEMP\tailscale.msi"
            
            Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath
            Start-Process msiexec.exe -Wait -ArgumentList "/i `"$installerPath`" /qn /norestart"
            Start-Sleep -Seconds 15
            
            # Check if installed
            if (Test-Path "C:\Program Files\Tailscale\tailscale.exe") {
                Write-Host "âœ… Tailscale installed"
            } else {
                Write-Host "âŒ Tailscale not found, trying alternate method..."
                # Try direct download and extract
                Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-ipn-setup-latest-amd64.exe" -OutFile "$env:TEMP\tailscale.exe"
                Start-Process "$env:TEMP\tailscale.exe" -ArgumentList "/S" -Wait
            }
            
            # Connect to Tailscale
            & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $env:TAILSCALE_AUTH_KEY --hostname "github-rdp-${{ github.run_id }}" --accept-dns=false
            
            # Get IP
            $tailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
            if ($tailscaleIP) {
                echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV
                Write-Host "âœ… Tailscale IP: $tailscaleIP"
            } else {
                Write-Host "âš ï¸  Could not get Tailscale IP"
                echo "TAILSCALE_IP=NOT_CONNECTED" >> $env:GITHUB_ENV
            }
            
        } catch {
            Write-Host "âŒ Tailscale installation failed: $_"
            echo "TAILSCALE_IP=ERROR" >> $env:GITHUB_ENV
        }

    - name: ðŸ”§ Enable RDP (Simple)
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ”§ ENABLING RDP"
        Write-Host "======================================================"
        
        try {
            # Enable RDP in registry
            reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
            reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
            
            # Start RDP service
            net start TermService 2>$null || sc config TermService start= auto
            net start TermService
            
            # Allow RDP in firewall
            netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
            
            Write-Host "âœ… RDP enabled on port 3389"
            
            # Verify
            $rdpStatus = reg query "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections
            Write-Host "RDP Registry Status: $rdpStatus"
            
        } catch {
            Write-Host "âš ï¸  RDP setup error: $_"
        }

    - name: ðŸ‘¤ Create User Account
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ‘¤ CREATING USER ACCOUNT"
        Write-Host "======================================================"
        
        $username = "RDP"
        $password = "D12345678@"  # Simple hardcoded password for testing
        
        echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        
        Write-Host "Username: $username"
        Write-Host "Password: $password"
        
        try {
            # Delete if exists
            net user $username /delete 2>$null
            
            # Create user
            net user $username $password /add /fullname:"GitHub User" /y
            
            if ($LASTEXITCODE -eq 0) {
                Write-Host "âœ… User created"
                
                # Activate
                net user $username /active:yes
                
                # Add to groups
                net localgroup "Remote Desktop Users" $username /add 2>$null
                net localgroup "Administrators" $username /add 2>$null
                
                Write-Host "âœ… User added to groups"
            } else {
                Write-Host "âŒ Failed to create user"
            }
            
        } catch {
            Write-Host "âš ï¸  User creation error: $_"
        }

    - name: ðŸ“‹ Show Connection Info
      run: |
        Write-Host ""
        Write-Host "======================================================"
        Write-Host "ðŸ”— CONNECTION INFORMATION"
        Write-Host "======================================================"
        Write-Host ""
        
        Write-Host "ðŸŒ TAILSCALE:"
        if (Test-Path "C:\Program Files\Tailscale\tailscale.exe") {
            & "C:\Program Files\Tailscale\tailscale.exe" status --json | ConvertFrom-Json | Select-Object TailscaleIPs, MagicDNSSuffix
        } else {
            Write-Host "   Tailscale not installed"
        }
        
        Write-Host ""
        Write-Host "ðŸ”‘ RDP CREDENTIALS:"
        Write-Host "   IP: $env:TAILSCALE_IP"
        Write-Host "   Username: $env:RDP_USERNAME"
        Write-Host "   Password: $env:RDP_PASSWORD"
        Write-Host ""
        Write-Host "ðŸš€ CONNECT: mstsc /v:$env:TAILSCALE_IP"
        Write-Host ""
        Write-Host "ðŸ”§ SERVICES:"
        net start | findstr "TermService" || echo "TermService not running"
        Write-Host ""
        Write-Host "ðŸ“¡ PORTS:"
        netstat -an | findstr ":3389" || echo "3389 not listening"
        Write-Host ""
        Write-Host "â° RUNNER TIMEOUT: 9933333333 minutes total"
        Write-Host "======================================================"

    - name: â³ Keep Alive (No Timeout)
      run: |
        Write-Host "======================================================"
        Write-Host "ðŸ”„ KEEPING RUNNER ALIVE"
        Write-Host "======================================================"
        
        Write-Host "Runner will stay active until timeout (90000000 minutes total)"
        Write-Host "You can now connect via RDP using the credentials above"
        Write-Host ""
        Write-Host "Press Ctrl+C in logs to stop early"
        Write-Host ""
        
        # Just sleep to keep runner alive
        # GitHub will auto-timeout after 99000000 minutes
        Write-Host "Sleeping for 1500 seconds (99000000 minutes)..."
        Start-Sleep -Seconds 1500
        
        Write-Host "â° Time almost up, preparing to exit..."

    - name: ðŸ§¹ Quick Cleanup
      if: always()
      run: |
        Write-Host "ðŸ§¹ Quick cleanup..."
        
        # Remove user
        net user $env:RDP_USERNAME /delete /y 2>$null
        
        # Disable RDP
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 1 /f 2>$null
        
        # Stop Tailscale if exists
        if (Test-Path "C:\Program Files\Tailscale\tailscale.exe") {
            & "C:\Program Files\Tailscale\tailscale.exe" down 2>$null
        }
        
        Write-Host "âœ… Cleanup done"
