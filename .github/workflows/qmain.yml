name: Enable RDP with Tailscale
on: [workflow_dispatch]

jobs:
  rdp-access:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸš€ Install Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "ğŸ“¥ Installing Tailscale..."
        $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath
        msiexec.exe /i $installerPath /qn /norestart
        Start-Sleep -Seconds 10
        
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $env:TAILSCALE_AUTH_KEY --hostname "github-rdp-${{ github.run_id }}" --accept-dns=false
        $tailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV

    - name: ğŸ”§ Enable and Configure RDP
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ”§ CONFIGURING RDP ACCESS"
        Write-Host "======================================================"
        
        # 1. Check current RDP status
        Write-Host "ğŸ“Š Current RDP Status:"
        Get-Service TermService, UmRdpService, SessionEnv | Format-Table Name, Status, StartType
        
        # 2. Enable RDP in registry
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        
        # 3. Disable NLA for easier connection
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1
        
        # 4. Start RDP services in correct order
        Write-Host "ğŸ”„ Starting RDP services..."
        
        # Set services to auto-start
        Set-Service -Name SessionEnv -StartupType Automatic -ErrorAction SilentlyContinue
        Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
        Set-Service -Name TermService -StartupType Automatic
        
        # Start services in order
        Start-Service SessionEnv -ErrorAction SilentlyContinue
        Start-Service UmRdpService -ErrorAction SilentlyContinue
        Start-Service TermService
        
        Write-Host "âœ… RDP services started"
        
        # 5. Configure firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
        netsh advfirewall firewall add rule name="GitHub Runner RDP" dir=in action=allow protocol=TCP localport=3389
        
        Write-Host "âœ… Firewall configured"

    - name: ğŸ‘¤ Create RDP User Account
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ‘¤ SETTING UP RDP USER ACCOUNT"
        Write-Host "======================================================"
        
        $username = "github-rdp-user"
        $password = [System.Web.Security.Membership]::GeneratePassword(12, 3)
        
        echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        
        # Check and create/update user
        $user = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
        
        if ($user) {
            Write-Host "ğŸ”„ Updating existing user..."
            Set-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force)
            Enable-LocalUser -Name $username
        } else {
            Write-Host "ğŸ†• Creating new user..."
            $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
            New-LocalUser -Name $username -Password $securePassword -FullName "GitHub RDP User"
            Enable-LocalUser -Name $username
        }
        
        # Add to required groups
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
        
        # Verify user setup
        Write-Host "âœ… User created:"
        Get-LocalUser -Name $username | Format-Table Name, Enabled, LastLogon

    - name: ğŸ“‹ Show RDP Connection Info
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ”— RDP CONNECTION INFORMATION"
        Write-Host "======================================================"
        Write-Host ""
        Write-Host "ğŸŒ TAILSCALE ACCESS:"
        Write-Host "   IP Address: $env:TAILSCALE_IP"
        Write-Host "   DNS: github-rdp-${{ github.run_id }}.your-tailnet.ts.net"
        Write-Host ""
        Write-Host "ğŸ”‘ RDP CREDENTIALS:"
        Write-Host "   ğŸ‘¤ USERNAME: $env:RDP_USERNAME"
        Write-Host "   ğŸ” PASSWORD: $env:RDP_PASSWORD"
        Write-Host ""
        Write-Host "ğŸš€ CONNECT COMMANDS:"
        Write-Host "   mstsc /v:$env:TAILSCALE_IP"
        Write-Host "   or"
        Write-Host "   mstsc /v:github-rdp-${{ github.run_id }}.your-tailnet.ts.net"
        Write-Host ""
        Write-Host "â° TIME LIMIT: ~25 minutes remaining"
        Write-Host ""
        Write-Host "ğŸ”§ SERVICES STATUS:"
        Get-Service TermService, UmRdpService, SessionEnv | Format-Table Name, Status -AutoSize
        Write-Host ""
        Write-Host "ğŸ“¡ RDP PORT STATUS:"
        netstat -an | findstr ":3389" || echo "Port 3389 not listening yet"
        Write-Host "======================================================"

    - name: â³ Keep Alive with Service Monitoring
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ”„ KEEPING RUNNER ACTIVE"
        Write-Host "======================================================"
        
        $timeout = 1500  # 25 minutes
        $startTime = Get-Date
        
        while (((Get-Date) - $startTime).TotalSeconds -lt $timeout) {
            $elapsed = [math]::Round(((Get-Date) - $startTime).TotalSeconds)
            $remaining = $timeout - $elapsed
            $minutes = [math]::Floor($remaining / 60)
            $seconds = $remaining % 60
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Time left: ${minutes}m ${seconds}s"
            
            # Monitor and restart services if needed
            $services = @("SessionEnv", "UmRdpService", "TermService")
            foreach ($service in $services) {
                $status = Get-Service -Name $service -ErrorAction SilentlyContinue
                if ($status.Status -ne "Running") {
                    Write-Host "âš ï¸  $service is not running. Attempting to start..."
                    Start-Service -Name $service -ErrorAction SilentlyContinue
                    Start-Sleep -Seconds 2
                }
            }
            
            # Show active RDP sessions
            try {
                $sessions = (qwinsta 2>$null | Select-String "rdp-tcp" | Measure-Object).Count
                Write-Host "   Active RDP sessions: $sessions"
            } catch {
                Write-Host "   Active RDP sessions: Unable to check"
            }
            
            # Show listening port
            $listening = (netstat -an 2>$null | Select-String ":3389" | Select-String "LISTENING" | Measure-Object).Count
            Write-Host "   Port 3389 listening: $(if ($listening -gt 0) {'âœ…'} else {'âŒ'})"
            
            Write-Host ""
            Start-Sleep -Seconds 30
        }
        
        Write-Host "â° Time limit reached, preparing for cleanup..."

    - name: ğŸ§¹ Proper Service Cleanup
      if: always()
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ§¹ SAFE SERVICE CLEANUP"
        Write-Host "======================================================"
        
        Write-Host "ğŸ” Current service states:"
        Get-Service TermService, UmRdpService, SessionEnv | Format-Table Name, Status, StartType
        
        Write-Host ""
        Write-Host "ğŸ›‘ Stopping RDP services (without force)..."
        
        # Stop services in reverse order (safely)
        $services = @("TermService", "UmRdpService", "SessionEnv")
        
        foreach ($service in $services) {
            try {
                Write-Host "Stopping $service..."
                Stop-Service -Name $service -Force -ErrorAction Stop
                Write-Host "âœ… $service stopped"
                Start-Sleep -Seconds 1
            } catch {
                Write-Host "âš ï¸  Could not stop $service: $_"
            }
        }
        
        Write-Host ""
        Write-Host "ğŸ”’ Disabling RDP in registry..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -ErrorAction SilentlyContinue
        
        Write-Host ""
        Write-Host "ğŸ‘¤ Removing temporary user..."
        $username = "github-rdp-user"
        try {
            Remove-LocalUser -Name $username -ErrorAction Stop
            Write-Host "âœ… User removed"
        } catch {
            Write-Host "âš ï¸  Could not remove user: $_"
        }
        
        Write-Host ""
        Write-Host "ğŸ›¡ï¸  Cleaning firewall rules..."
        netsh advfirewall firewall delete rule name="GitHub Runner RDP" protocol=TCP localport=3389 2>$null
        
        Write-Host ""
        Write-Host "ğŸ”Œ Disconnecting Tailscale..."
        & "C:\Program Files\Tailscale\tailscale.exe" down 2>$null
        
        Write-Host ""
        Write-Host "âœ… Cleanup complete!"
        Write-Host "ğŸ“ Note: Runner will automatically terminate after timeout"

    - name: ğŸ“Š Final Status Report
      if: always()
      run: |
        Write-Host "======================================================"
        Write-Host "ğŸ“Š FINAL STATUS REPORT"
        Write-Host "======================================================"
        Write-Host ""
        Write-Host "ğŸ” SECURITY STATUS:"
        Write-Host "   RDP Service: DISABLED"
        Write-Host "   User Account: REMOVED"
        Write-Host "   Tailscale: DISCONNECTED"
        Write-Host "   Firewall Rules: CLEANED"
        Write-Host ""
        Write-Host "âœ… All temporary access has been revoked"
        Write-Host "ğŸš« No persistent credentials remain"
        Write-Host "ğŸ Runner cleanup completed successfully"
